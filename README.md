spicy.history
=============

Приложение Django для SpicyCMS. Использует [концепцию реиспользования кода и конфигурации spicy.core](https://github.com/spicycms/spicy.core). Это простое приложение использует по умолчанию типовые шаблоны и часть логики ``spicy.core.admin``, предоставляет сервис ``HistoryService``, реализующий действия с историей изменений - сохранение, просмотр, откат к предыдущим версиям.

Для запуска необходима версия 1.4.11 - 1.5.12 Django.

Назначение
----------
Модуль предназначен для ведения истории изменений объектов на сайте, просмотра изменений в стиле ``git diff``, отката к предыдущим версиям. Вы можете настроить spicy.history так, чтобы отслеживать изменения документов, медиафайлов, профилей пользователей, любых других объектов, любых полей этих объектов. 

Подключить spicy.history к вашему приложению
--------------------------------------------
Установите модуль с помощью pip: ``pip install git+https://github.com/spicycms/spicy.history#egg=spicy.history``.

Добавьте в настройки установленных приложений и в список сервисов в ``settings.py``:
```
INSTALLED_APPS = (
    ...
    'spicy.history',
    ...
)

SERVICES = (
    'spicy.history.services.HistoryService',
    ...
)
```

Добавьте в ``urls.py`` путь для модуля spicy.history в ``settings.py``:
```
urlpatterns = patterns('',
    ...
    url(r'^', include('spicy.history.urls', namespace='history')),
    ...
)
```

После этого необходимо выполнить ``manage.py syncdb``, чтобы Django создала таблицы spicy.history в базе данных. Ваше приложение настроено, чтобы использовать spicy.history. Теперь нужно [настроить](./README.md#Настройка-истории-для-объектов), для каких объектов на сайте вести историю.

Настройка истории для объектов
------------------------------
Вы можете указать spicy.history отслеживать любое поле любой модели приложения. Для этого в ``settings.py`` укажите:
```
OBSERVED_FIELDS = {
    'webapp.Document': ('body', 'slug', 'title', 'pub_date'),
    ...
}
```
В этом примере, spicy.history настроен на отслеживание модели документа ``Document``, будут сохраняться изменения для полей ``body``, ``slug``, ``title``, ``pub_date``. Аналогично вы можете добавить и другие модели в ``OBSERVED_FIELDS``, перечислив их поля.

Другие настройки spicy.history
------------------------------
* ``AUTHORS_TOP_LIMIT`` - максимальное количество наиболее часто изменяющих объекты пользователей. Выводится в список активных пользователей в шаблоне ``history/authors_top.html``, значение по умолчанию - 10.

Для Django программиста
-----------------------
Ниже приведены детали реализации spicy.history с описанием моделей и методов сервиса.

### Модели spicy.history
Модуль использует 2 основные модели - ``Action`` и ``Diff``. ``Action`` хранит информацию о том, кем, когда и какой [тип изменения](https://github.com/spicycms/spicy.history/blob/develop/src/spicy/history/defaults.py#L22) был сделан для определенного объекта. Модель ``Diff`` хранит данные о том, какое поле было изменено, новое значение и версию.

Эти модели имеют методы и свойства:

* ``Diff.first_version()`` - возвращает первую версию отслеживаемого поля объекта. Реализовано с декоратором ``@cached_property``.

Сразу после подключения spicy.history при создании объекта отслеживаемой модели происходит первая запись в историю - о создании объекта, это считается первой версией. Любое действие на запись в базу данных через ORM будет добавлять записи в историю изменений.

Если вы подключаете spicy.history к уже работающему приложению, например, для отслеживания документов, то первые версии не будут созданы автоматически, вам нужно будет создать их "вручную" (используя Django ORM), например, через команду менеджмента.

* ``Diff.prev_version()`` - возвращает предыдущую версию для текущего объекта класса ``Diff``. Реализовано с декоратором ``@cached_property``.

* ``Diff.next_version()`` - возвращает следующую версию для текущего объекта класса ``Diff``. Реализовано с декоратором ``@cached_property``.

Если у объекта нет предыдущей или следующей версии, методы ``prev_version`` и ``prev_version`` возвращают ``None``.

* ``Diff.last_version()`` - возвращает последнюю версию отслеживаемого поля объекта. Реализовано с декоратором ``@cached_property``.

* ``Diff.get_version_text()`` - возвращает текстовое представление изменения, с версией.

* ``Diff.verbose_field_name()`` - возвращает varbose_name поля, для которого было сделано это изменение.


### Сервис spicy.history
Кроме моделей, spicy.history также предоставляет сервис ``HistoryService``, который дает доступ к провайдеру с [полезными методами](https://github.com/spicycms/spicy.history/blob/develop/src/spicy/history/services.py#L22) для истории изменений, которые вы можете использовать в ваших обработчиках:

```
from spicy.core.service import api

def your_view(request):
    item = YourModel.objects.all()[0]   # случайный объект, для которого настроено отслеживание изменений
    hist_service = api.register['history']                      # сервис spicy.history
    prov = hist_service.get_provider_instances(consumer=item)   # провайдер spicy.history
    # тут вы можете использовать методы провайдера
```

#### Методы провайдера spicy.history
Кроме использования провайдера в ваших обработчиках через ``api.register['history']``, вы можете обращаться к ним напрямую по URL.

* Доступ к методу вы можете получить из шаблона, используя ``{% url 'service:public:history-list' 'document' doc.pk as history_url %}`` - так в контекст шаблона будет добавлена переменная ``history_url`` - путь к методу провайдера, который возвращает шаблон со списком изменений для указанного объекта (в этом примере тип объекта ``Document``, с ``pk=doc.pk``) services/list.html. Внутри этого шаблона доступны переменные.

{TODO как получить доступ к сервису через api.reg[hist], методы провайдера, по каким урлам к ним обращаться из шаблонов}

#### Список переменных шаблонов spicy.history
{TODO переменные которые передаются в шаблоны методов провайдера} 

### Refactoring
Не используются:

* Настройка defaults.py ``TIMELINE_PAGE_DAYS``
* Настройка defaults.py ``TIMELINE_FEED_DAYS``




