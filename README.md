spicy.history
=============

Приложение Django для SpicyCMS. Использует [концепцию реиспользования кода и конфигурации spicy.core](https://github.com/spicycms/spicy.core). Это простое приложение использует по умолчанию типовые шаблоны и часть логики ``spicy.core.admin``, предоставляет сервис ``HistoryService``, реализующий действия с историей изменений - сохранение, просмотр, откат к предыдущим версиям.

Для запуска необходима версия 1.4.11 - 1.5.12 Django.

Назначение
----------
Модуль предназначен для ведения истории изменений объектов на сайте, просмотра изменений в стиле ``git diff``, отката к предыдущим версиям. Вы можете настроить spicy.history так, чтобы отслеживать изменения документов, медиафайлов, профилей пользователей, любых других объектов, любых полей этих объектов. 

Подключить spicy.history к вашему приложению
--------------------------------------------
Установите модуль с помощью pip: ``pip install git+https://github.com/spicycms/spicy.history#egg=spicy.history``.

Добавьте в настройки установленных приложений и в список сервисов в ``settings.py``:
```
INSTALLED_APPS = (
    ...
    'spicy.history',
    ...
)

SERVICES = (
    'spicy.history.services.HistoryService',
    ...
)
```

Добавьте в ``urls.py`` путь для модуля spicy.history в ``settings.py``:
```
urlpatterns = patterns('',
    ...
    url(r'^', include('spicy.history.urls', namespace='history')),
    ...
)
```

После этого необходимо выполнить ``manage.py syncdb``, чтобы Django создала таблицы spicy.history в базе данных. Ваше приложение настроено, чтобы использовать spicy.history. Теперь нужно [настроить](./README.md#Настройка-истории-для-объектов), для каких объектов на сайте вести историю.

Настройка истории для объектов
------------------------------
Вы можете указать spicy.history отслеживать любое поле любой модели приложения. Для этого в ``settings.py`` укажите:
```
OBSERVED_FIELDS = {
    'webapp.Document': ('body', 'slug', 'title', 'pub_date'),
    ...
}
```
В этом примере, spicy.history настроен на отслеживание модели документа ``Document``, будут сохраняться изменения для полей ``body``, ``slug``, ``title``, ``pub_date``. Аналогично вы можете добавить и другие модели в ``OBSERVED_FIELDS``, перечислив их поля.

Другие настройки spicy.history
------------------------------
* ``AUTHORS_TOP_LIMIT`` - максимальное количество наиболее часто изменяющих объекты пользователей. Выводится в список активных пользователей в шаблоне ``history/authors_top.html``, значение по умолчанию - 10.

Для Django программиста
-----------------------
Ниже приведены детали реализации spicy.history с описанием моделей и методов сервиса.

### Модели spicy.history
Модуль использует 2 основные модели - ``Action`` и ``Diff``. ``Action`` хранит информацию о том, кем, когда и какой [тип изменения](https://github.com/spicycms/spicy.history/blob/develop/src/spicy/history/defaults.py#L22) был сделан для определенного объекта. Модель ``Diff`` хранит данные о том, какое поле было изменено, новое значение и версию.

Эти модели имеют методы:

* ``Diff.first_version()`` - возвращает первую версию отслеживаемых полей объекта.

Сразу после подключения spicy.history при создании объекта отслеживаемой модели происходит первая запись в историю - о создании объекта, это считается первой версией. Любое действие на запись в базу данных через ORM будет добавлять записи в историю изменений.

Если вы подключаете spicy.history к уже работающему приложению, например, для отслеживания документов, то первые версии не будут созданы автоматически, вам нужно будет создать их "вручную" (используя Django ORM), например, через команду менеджмента.

{TODO описать Action, Diff. Что происходит при изменении отслеживаемых объектов}


### Сервис spicy.history
{TODO как получить доступ к сервису через api.reg[hist], методы провайдера, по каким урлам к ним обращаться из шаблонов}


### Refactoring
Не используются:

* Настройка defaults.py ``TIMELINE_PAGE_DAYS``
* Настройка defaults.py ``TIMELINE_FEED_DAYS``




